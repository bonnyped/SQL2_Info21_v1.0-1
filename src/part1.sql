-- CREATE DATABASE model_s21;
DROP TABLE IF EXISTS Friends;
DROP TABLE IF EXISTS TransferredPoints;
DROP TABLE IF EXISTS Recommendations;
DROP TABLE IF EXISTS TimeTracking;
DROP TABLE IF EXISTS Peers;

-- TRUNCATE TABLE  Peers CASCADE; -- очистит все таблицы которые с ней связаны внешним ключом
-- TRUNCATE TABLE  Friends;
-- TRUNCATE TABLE  TransferredPoints;
-- TRUNCATE TABLE Recommendations;
-- TRUNCATE TABLE TimeTracking;

CREATE TABLE Peers (
    Nickname VARCHAR NOT NULL PRIMARY KEY UNIQUE,
    Birthday DATE NOT NULL default current_date::DATE
);

CREATE TABLE IF NOT EXISTS Friends (
    ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1),
    Peer1 VARCHAR NOT NULL,
    Peer2 VARCHAR NOT NULL,
    FOREIGN KEY (Peer1) REFERENCES Peers (Nickname),
    FOREIGN KEY (Peer2) REFERENCES Peers (Nickname)
);

CREATE TABLE IF NOT EXISTS TransferredPoints (
    ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1),
    -- generation??
    CheckingPeer VARCHAR NOT NULL,
    CheckedPeer VARCHAR NOT NULL,
    PointsAmount BIGINT DEFAULT 0,
    FOREIGN KEY (CheckingPeer) REFERENCES Peers (Nickname),
    FOREIGN KEY (CheckedPeer) REFERENCES Peers (Nickname)
);

CREATE TABLE IF NOT EXISTS TimeTracking (
    ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1),
    Peer VARCHAR NOT NULL,
    "Date" DATE DEFAULT CURRENT_TIMESTAMP::DATE,
    "Time" TIME DEFAULT CURRENT_TIMESTAMP::TIME,
    "State" SMALLINT DEFAULT 1 check ("State" IN (1, 2)),
    FOREIGN KEY (Peer) REFERENCES Peers (Nickname)
);

CREATE TABLE IF NOT EXISTS Recommendations (
    ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1),
    Peer VARCHAR NOT NULL,
    RecommendedPeer VARCHAR NOT NULL,
    FOREIGN KEY (Peer) REFERENCES Peers (Nickname),
    FOREIGN KEY (RecommendedPeer) REFERENCES Peers (Nickname)
);

INSERT INTO Peers (Nickname, Birthday)
VALUES ('kennethgraham', '1999-10-23'),
    ('nancywilson', '1978-06-08'),
    ('troybrown', '1964-11-03'),
    ('laurenwood', '2004-02-29'),
    ('nancymartinez', '1995-08-06'),
    ('pamelawalker', '1992-12-13'),
    ('lorigarrett', '1970-09-30'),
    ('josepayne', '1988-01-07'),
    ('frankray', '2005-05-25'),
    ('lloydmartin', '1999-09-06');

INSERT INTO Friends (Peer1, Peer2)
VALUES ('kennethgraham', 'nancymartinez'),
    ('kennethgraham', 'laurenwood'),
    ('troybrown', 'nancywilson'),
    ('nancywilson', 'laurenwood'),
    ('laurenwood', 'nancymartinez');
    
INSERT INTO TransferredPoints (id, CheckingPeer, CheckedPeer, PointsAmount)
VALUES -- через запрос к p2p???
    (1, 'kennethgraham', 'nancymartinez', 1),
    (2, 'kennethgraham', 'laurenwood', 1),
    (3, 'kennethgraham', 'troybrown', 1),
    (4, 'nancywilson', 'laurenwood', 2),
    (5, 'laurenwood', 'nancywilson', 2);

-- INSERT INTO TransferredPoints
-- VALUES 
-- (
--     (SELECT max(id) + 1 FROM  TransferredPoints),
--     SELECT p2p.CheckingPeer, Checks.Peer, COALESCE(count(*)+1, 1)
--     FROM p2p JOIN comments ON p2p.Check = Checks.Id JOIN TransferredPoints AS tp
--     GROUP BY tp.checkingpeer, p2p.CheckingPeer, tp.checkedpeer, Checks.Peer
-- );

INSERT INTO Recommendations (id, Peer, RecommendedPeer)
VALUES (1, 'laurenwood', 'nancymartinez'),
    (2, 'kennethgraham', 'laurenwood'),
    (3, 'laurenwood', 'nancywilson'),
    (4, 'nancywilson', 'laurenwood'),
    (5, 'laurenwood', 'troybrown');
INSERT INTO TimeTracking (id, Peer, "Date", "Time", "State")
VALUES (1, 'laurenwood', '2022-12-23', '10:14', 1),
    (2, 'laurenwood', '2022-12-23', '14:02', 2),
    (3, 'laurenwood', '2022-12-23', '14:19', 1),
    (4, 'laurenwood', '2022-12-23', '19:43', 2),
    (5, 'nancywilson', '2022-12-23', '22:04', 1);